<!DOCTYPE HTML>
<html>
<head>
<title>天気予報</title>
<meta name="Description" content="">
<meta name="Keywords" content="">
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta http-equiv="content-style-type" content="text/css">
<meta name="viewport" content="width=device-width, initial-scale=1, minimum-scale=1, maximum-scale=1, user-scalable=yes">
<link rel="stylesheet" href="../css/common.css">
<link rel="stylesheet" href="css/index.css">
<link href="https://fonts.googleapis.com/css2?family=Montserrat&family=Noto+Sans+JP&display=swap" rel="stylesheet">
</head>
<body>

<div class="wrap">
	<header>
		<h1>天気予報</h1>
		<img src="img/img_nyan.png" alt="にゃんこ">
	</header>

	<main>
		<div class="container">
			<section>
				<h3 id="place"></h3>
				<div id="weather">
					<div id="now"></div>
				</div>

				<table id="forecast"></table>
			</section>
		</div>
	</main>
</div>

<footer>
	<small>&#169; 2020  KYOKO NOZAKI</small>
</footer>


<script src="../js/jquery.js"></script>
<script>
'use strict';

navigator.geolocation.getCurrentPosition(success, fail);

function success(pos) {
	ajaxRequest(pos.coords.latitude, pos.coords.longitude);
}

function fail(error) {
	alert('位置情報の取得に失敗しました。エラーコード：' + error.code);
}

// UTCをミリ秒に
function utcToJSTime(utcTime) {
	return utcTime * 1000;
}

// データ取得
function ajaxRequest(lat, long) {
	const url = 'https://api.openweathermap.org/data/2.5/forecast';
	const appId = 'dd64b46ea595c4104e0881953cb4e287';

	$.ajax({
		url: url,
		data: {
			appid: appId,
			lat: lat,
			lon: long,
			units: 'metric',
			lang: 'ja'
		}
	})
	.done(function(data) {
		// 都市名、国名
		$('#place').text(data.city.name);

		// 天気予報データ
		data.list.forEach(function(forecast, index) {
			const dateTime = new Date(utcToJSTime(forecast.dt));
			const month = dateTime.getMonth() + 1;
			const date = dateTime.getDate();
			const hours = dateTime.getHours();
			const min = String(dateTime.getMinutes()).padStart(2, '0');
			const temperature = Math.round(forecast.main.temp);
			const description = forecast.weather[0].description;
			const iconPath = `img/${forecast.weather[0].icon}.svg`;

			// 現在の天気とそれ以外で出力を変える
			if(index === 0) {
				const currentWeather = `
					<div class="info">
						<p>
							<span class="description">現在の天気：${description}</span>
							<span class="temp">${temperature}</span>°C
						</p>
					</div>
					<div class="icon"><img src="${iconPath}"></div>
				`;
				$('#weather').html(currentWeather);
			} else {
				const tableRow = `
					<tr>
						<td class="info">
							${month}/${date}<br>${hours}:${min}
						</td>
						<td class="icon"><img src="${iconPath}"></td>
						<td><span class="description">${description}</span></td>
						<td><span class="temp">${temperature}°C</span></td>
					</tr>`;
				$('#forecast').append(tableRow);
			}
		});
	})
	.fail(function() {
		console.log('$.ajax failed!');
	})
}
</script>
</body>
</html>